name: Build Windows SDK package
on: push

jobs:
  build_toolchain:
    name: Build Windows toolchain
    runs-on: ubuntu-latest
    container:
      image: tari/libfxcg-toolchain
    steps:
      - name: Install packages
        run: |
          apt-get -qqy update
          apt-get -qq install build-essential curl mingw-w64 texinfo

      - uses: actions/cache@v1
        id: cache-binaries
        name: Cache toolchain binaries
        with:
          path: toolchain-bin
          key: toolchain-win-gcc9.3.0_binutils2.34
      - uses: actions/cache@v1
        id: cache-sources
        if: steps.cache-binaries.outputs.cache-hit != 'true'
        name: Cache toolchain sources
        with:
          path: toolchain-src
          key: toolchain-src-gcc9.3.0

      - name: Download toolchain sources
        if: steps.cache-binaries.outputs.cache-hit != 'true' && steps.cache-sources.outputs.cache-hit != 'true'
        run: |
          mkdir toolchain-src && cd toolchain-src
          curl -L http://ftpmirror.gnu.org/binutils/binutils-2.34.tar.bz2 | tar xj
          curl -L http://ftpmirror.gnu.org/gcc/gcc-9.3.0/gcc-9.3.0.tar.xz | tar xJ
          curl -L http://ftpmirror.gnu.org/mpfr/mpfr-4.0.2.tar.xz | tar xJ
          ln -sr mpfr-4.0.2 ./gcc-9.3.0/mpfr
          curl -L http://ftpmirror.gnu.org/gmp/gmp-6.2.0.tar.xz | tar xJ
          ln -sr gmp-6.2.0 ./gcc-9.3.0/gmp
          curl -L http://ftpmirror.gnu.org/mpc/mpc-1.1.0.tar.gz | tar xz
          ln -sr mpc-1.1.0 ./gcc-9.3.0/mpc

      - name: Build toolchain
        if: steps.cache-binaries.outputs.cache-hit != 'true'
        run: |
          mkdir -p toolchain-build/binutils toolchain-build/gcc toolchain-bin

          cd toolchain-build/binutils
          ../../toolchain-src/binutils-2.34/configure \
              --target=sh3eb-elf --host=i686-w64-mingw32 \
              --disable-nls --prefix=
          make -j$(nproc)
          make DESTDIR=${GITHUB_WORKSPACE}/toolchain-bin install

          cd ../gcc
          ../../toolchain-src/gcc-9.3.0/configure \
              --target=sh3eb-elf --with-endian=big \
              --with-pkgversion=PrizmSDK \
              --host=i686-w64-mingw32 \
              --prefix= \
              --without-headers --enable-languages=c,c++ \
              --disable-tls --disable-nls --disable-threads --disable-shared \
              --disable-libssp --disable-libvtv --disable-libada \
              --disable-gcov --disable-libgomp

          make -j$(nproc) inhibit_libc=true all-gcc
          make DESTDIR=${GITHUB_WORKSPACE}/toolchain-bin install-gcc

          make -j$(nproc) inhibit_libc=true all-target-libgcc
          make DESTDIR=${GITHUB_WORKSPACE}/toolchain-bin install-target-libgcc

          cd ${GITHUB_WORKSPACE}/toolchain-bin
          find . -name '*.exe' -exec i686-w64-mingw32-strip {} \;

      - uses: actions/upload-artifact@v1
        with:
          name: toolchain-bin-gcc9.3.0
          path: toolchain-bin

  build_libfxcg:
    name: Build libfxcg
    runs-on: ubuntu-latest
    container:
      image: tari/libfxcg-toolchain
    steps:
      - uses: actions/checkout@v2
      - name: Compile
        run: |
          make
          mkdir dist
          cp -r lib include dist
      - uses: actions/upload-artifact@v1
        with:
          name: libfxcg
          path: dist
