name: Nicotine+ packaging CI

on:
  push:
    branches:
      - master
      - add_github_ci
  pull_request:
    branches:
      - master

env:
  # workaround until figuring out how to dynamically read this from source code
  NICOTINE_VERSION: 1.4.3-2
  DEBUILD_SOURCE: debuild-source

jobs:
  package:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install dependencies
        run: |
          sudo apt-get install devscripts debhelper dh-python python-all \
            python-gobject-2 python-setuptools quilt
          sudo apt-get -y install dh-python python3 python3-pytest gettext lintian python3-setuptools quilt
      - name: Build source .deb
        run: |
          ./debian/rules get-orig-source
          dpkg-buildpackage -S -sa -us -uc
      - name: Collect source .deb artifacts
        run: |
          mkdir ../source
          mv ../nicotine_${NICOTINE_VERSION}* ../nicotine_*.orig.tar.* ../source
      - name: Archive source .deb artifacts
        uses: actions/upload-artifact@v1
        with:
          name: debuild-source
          path: ../source

  autopkgtest:
    runs-on: ubuntu-latest
    needs: package
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v1
      with:
        name: debuild-source
    - name: Install autopkgtest dependencies
      run: |
        curl https://bazel.build/bazel-release.pub.gpg | sudo apt-key add -
        sudo apt-get update
        sudo apt-get upgrade
        sudo apt install autopkgtest bazel
    - name: Run autopkgtest image
      run: |
        sudo autopkgtest --shell-fail --apt-upgrade \
          ./${DEBUILD_SOURCE}/nicotine_${NICOTINE_VERSION}_source.changes -- \
          null
