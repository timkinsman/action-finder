name: Linux MinGW
on:
  - push
  - pull_request
jobs:
  package:
    name: Package
    strategy:
      fail-fast: false
      matrix:
        architecture:
          - x86
          - x64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - name: Install packages
        run: |
          sudo apt update
          sudo apt install -y -V \
            autoconf-archive \
            automake1.11 \
            autotools-dev \
            bison \
            cmake \
            gettext \
            libevent-dev \
            libluajit-5.1-dev \
            libmecab-dev \
            libmsgpack-dev \
            mecab-naist-jdic \
            nsis \
            python3-pip \
            rapidjson-dev \
            ruby-dev \
            zip \
            zlib1g-dev
      - name: Install Sphinx
        run: |
          sudo pip3 install Sphinx
      - name: Generate configure
        run: |
          ./autogen.sh
      - name: Configure
        run: |
          ./configure \
            --enable-debug \
            --enable-document \
            --enable-mruby \
            --with-ruby
      - name: Build archive
        run: |
          make dist
      - name: Build
        run: |
          make \
            -C packages/windows \
            ARCHITECTURES=${{ matrix.architecture }} \
            build
      - name: Build zip archive
        run: |
          make \
            -C packages/windows \
            ARCHITECTURES=${{ matrix.architecture }} \
            package
      - name: Build installer
        run: |
          make \
            -C packages/windows \
            installer-${{ matrix.architecture }}

      # Artifact
      - name: Prepare artifacts
        run: |
          mkdir -p windows-mingw-${{ matrix.architecture }}
          mv packages/windows/files/* windows-mingw-${{ matrix.architecture }}/
      - uses: actions/upload-artifact@v2
        with:
          name: windows-mingw-${{ matrix.architecture }}
          path: windows-mingw-${{ matrix.architecture }}
  pdb:
    name: PDB
    needs:
      - package
    strategy:
      fail-fast: false
      matrix:
        architecture:
          - x86
          - x64
    runs-on: windows-2019
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: windows-mingw-${{ matrix.architecture }}
          path: windows-mingw-${{ matrix.architecture }}
      - name: Generate PDB
        run: |
          cd windows-mingw-${{ matrix.architecture }}
          bin\generate-pdb.bat
      - name: Prepare artifacts
        run: |
          Move-Item `
            windows-mingw-${{ matrix.architecture }} `
            windows-mingw-with-pdb-${{ matrix.architecture }}
      - uses: actions/upload-artifact@v2
        with:
          name: windows-mingw-with-pdb-${{ matrix.architecture }}
          path: windows-mingw-with-pdb-${{ matrix.architecture }}
  test:
    name: Test
    needs:
      - pdb
    strategy:
      fail-fast: false
      matrix:
        architecture:
          - x86
          - x64
    runs-on: windows-2019
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: windows-mingw-with-pdb-${{ matrix.architecture }}
          path: windows-mingw-with-pdb-${{ matrix.architecture }}
      - name: Setup environment
        run: |
          $INSTALL_FOLDER = "windows-mingw-with-pdb-${{ matrix.architecture }}"
          Write-Output "::set-env name=INSTALL_FOLDER::${INSTALL_FOLDER}"
          $FULL_INSTALL_FOLDER = "$(Get-Location)\${INSTALL_FOLDER}"
          Write-Output "::set-env name=FULL_INSTALL_FOLDER::${FULL_INSTALL_FOLDER}"
      - uses: actions/setup-ruby@v1
      - name: Update MSYS2
        run: |
          ridk exec pacman --sync --refresh --sysupgrade --noconfirm
      - name: Update GCC
        run: |
          ridk exec pacman --sync --noconfirm mingw-w64-x86_64-gcc
      - name: Install grntest
        run: |
          git clone --depth 1 `
            https://github.com/groonga/grntest.git `
            ..\grntest
          cd ..\grntest
          bundle install
          bundle exec ruby -rdevkit -S rake install
          gem install red-arrow
      - name: "Test: command line"
        run: |
          ruby test\command_line\run-test.rb `
            --groonga-install-prefix="${Env:INSTALL_FOLDER}"
      - name: "Test: HTTP: reference count"
        run: |
          $Env:GRN_ENABLE_REFERENCE_COUNT = "yes"
          grntest `
            --base-directory test\command `
            --groonga "${Env:FULL_INSTALL_FOLDER}\bin\groonga.exe" `
            --interface http `
            --n-retries 2 `
            --n-workers ${Env:NUMBER_OF_PROCESSORS} `
            --read-timeout 30 `
            --reporter mark `
            --timeout 60 `
            test\command\suite
      - name: "Test: HTTP: Apache Arrow: chunked"
        run: |
          grntest `
            --base-directory test\command `
            --groonga "${Env:FULL_INSTALL_FOLDER}\bin\groonga.exe" `
            --input-type apache-arrow `
            --interface http `
            --n-retries 2 `
            --n-workers ${Env:NUMBER_OF_PROCESSORS} `
            --read-timeout 30 `
            --reporter mark `
            --timeout 360 `
            --use-http-chunked `
            test\command\suite
  release:
    name: Release
    needs:
      - pdb
    strategy:
      fail-fast: false
      matrix:
        architecture:
          - x86
          - x64
    runs-on: ubuntu-latest
    if: |
      startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: windows-mingw-with-pdb-${{ matrix.architecture }}
          path: windows-mingw-with-pdb-${{ matrix.architecture }}
      - name: Asset
        id: asset
        run: |
          version=$(echo ${{ github.ref }} | sed -e 's,^refs/tags/v,,')
          echo ::set-output name=version::${version}
          base_name=groonga-${version}-${{ matrix.architecture }}
          echo ::set-output name=base_name::${base_name}
      - name: Create assets
        run: |
          base_name=${{ steps.asset.outputs.base_name }}
          cp -a \
            windows-mingw-with-pdb-${{ matrix.architecture }} \
            ${base_name}
          zip -r \
            ${base_name}.zip \
            ${base_name}
      - name: Ensure creating release
        id: create-release
        uses: actions/github-script@0.4.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const AsyncFunction = Object.getPrototypeOf(async () => {}).constructor
            const fs = require("fs");
            const path = ".github/workflows/ensure-creating-release.js";
            const script = fs.readFileSync(path).toString();
            const func = new AsyncFunction("require", "github", "context", script);
            return await func(require, github, context);
      - name: Upload to release
        uses: actions/upload-release-asset@v1.0.1
        if: |
          startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create-release.outputs.result }}
          asset_path: ${{ steps.asset.outputs.base_name }}.zip
          asset_name: ${{ steps.asset.outputs.base_name }}.zip
          asset_content_type: application/zip
