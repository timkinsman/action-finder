name: Release Beta
on:
  repository_dispatch:
    types: [deploy_beta]

jobs:
  build:

    runs-on: ubuntu-latest

    if: github.actor == github.event.repository.owner.login

    steps:
      - name: Configure SSH keys
        env:
          deployment_private_key: ${{ secrets.deployment_private_key }}
        run: |
          mkdir ~/.ssh
          echo "${{ secrets.deployment_private_key }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Checkout
        run: git clone git@github.com:klassm/andFHEM.git

      - name: Release
        run: |
          PWD="$(pwd)"
          mkdir -p ~/.gradle
          touch ~/.gradle/gradle.properties
          P12_FILE="${PWD}/play-store.p12"
          echo "${{ secrets.andFHEMPlayUploadP12Base64 }}" | base64 --decode > "${P12_FILE}"

          echo "andFHEMReleaseStorePassword=${{ secrets.andFHEMReleaseStorePassword }}" >> ~/.gradle/gradle.properties
          echo "andFHEMReleaseAliasPassword=${{ secrets.andFHEMReleaseAliasPassword }}" >> ~/.gradle/gradle.properties
          echo "andFHEMGithubToken=${{ secrets.andFHEMGithubToken }}" >> ~/.gradle/gradle.properties
          echo "andFHEMReleaseAccount=${{ secrets.andFHEMReleaseAccount }}" >> ~/.gradle/gradle.properties
          echo "andFHEMReleaseP12=${P12_FILE}" >> ~/.gradle/gradle.properties

          cd andFHEM
          git config user.email "andFHEM@klass.i"
          git config user.name "AndFHEM"
          ./gradlew clean release -Dstage=beta
