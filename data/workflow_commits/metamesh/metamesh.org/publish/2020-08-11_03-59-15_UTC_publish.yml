name: Publish Site to GitHub Pages


on:
  push:
    branches:
      - master


jobs:
  publish:
    runs-on: ubuntu-20.04
    steps:

      - name: Get source repo
        uses: actions/checkout@v2
        with:
          ref: master

      - name: Get Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: "0.74.2"
          extended: true

      - name: Announce env debug info
        run: |
          hugo env
          hugo config

      - name: Build site
        run: hugo --debug --i18n-warnings --enableGitInfo --ignoreCache --minify --baseURL "${{ env.BASE_URL }}"
        env:
          BASE_URL: ${{ secrets.BASE_URL }}

      # Required in order to have the same site across multiple repos for GitHub Pages
      - name: "Modify site: patch in Forestry Site ID"
        run: "sed -i 's/siteId: \":^xxxXxxx^:\",/siteId: \"${{ env.FORESTRY_SITE_ID }}\",/' public/admin/index.html"
        env:
          FORESTRY_SITE_ID: ${{ secrets.FORESTRY_SITE_ID }}

      - name: Deploy built site to gh-pages branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          commit_message: "Last Published: ${{ github.event.created_at }}"
          force_orphan: true
