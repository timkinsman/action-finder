name: Build and release

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: preinstall
      run: sudo apt-get install libxml2-utils
    - name: create_dirs
      run: mkdir -p /home/runner/work/percolator/my_rel /home/runner/work/percolator/my_build
    - name: configure_and_make
      run: admin/builders/ubuntu64_build.sh -s /home/runner/work/percolator -r /home/runner/work/percolator/my_rel -b /home/runner/work/percolator/my_build
    - name: test
      run: cd /home/runner/work/percolator/my_build/percolator && sudo make install && make test ARGS="-V"
    - name: Upload packages
      uses: actions/upload-artifact@v1
      with:
        name: ubuntu-packages
        path: /home/runner/work/percolator/my_rel

  build-osx:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v2
    - name: chech Applications
      run: ls /Applications
    - name: dir_names
      run: echo ${HOME}
    - name: create_dirs
      run: mkdir -p ${HOME}/work/percolator/my_rel ${HOME}/work/percolator/my_build
    - name: configure_and_make
      run: admin/builders/osx64_build.sh -s ${HOME}/work/percolator -r ${HOME}/work/percolator/my_rel -b ${HOME}/work/percolator/my_build
    - name: test
      run: cd /home/runner/work/percolator/my_build/percolator && sudo make install && make test ARGS="-V"
    - name: Upload packages
      uses: actions/upload-artifact@v1
      with:
        name: osx-packages
        path: ${HOME}/work/percolator/my_rel


  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: cmd
    steps:
    - uses: actions/checkout@v2
    - name: create_dirs
      run: CD .. || MKDIR my_rel my_build
    - name: configure_and_make
      run: |
        CD ..
        SET base_dir=%cd%
        ECHO %base_dir%
        CALL percolator\admin\builders\actionsw64_build.bat -s %base_dir% -r %base_dir%\my_rel -b %base_dir%\my_build
        EXIT /B
    - name: Upload packages
      uses: actions/upload-artifact@v1
      with:
        name: windows-packages
        path: ..\my_rel
