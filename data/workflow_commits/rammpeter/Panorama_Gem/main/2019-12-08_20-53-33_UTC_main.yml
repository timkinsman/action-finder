name: Panorama_Gem CI

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        management_pack_license: ["diagnostics_and_tuning_pack", "diagnostics_pack", "panorama_sampler", "none"]
    env:
      JRUBY_VERSION: jruby-9.2.6.0
      # Panorama dir after git clone
      PANORAMA_DIR: /home/runner/work/Panorama_Gem/Panorama_Gem
      MANAGEMENT_PACK_LICENSE: ${{ matrix.management_pack_license }}

    steps:
    - uses: actions/checkout@v1
    - name: Check OS prerequisites
      run: |
        docker ps -a
        docker images
        java -version

    - name: Set up RVM
      run: |
        curl -sSL https://get.rvm.io | bash

    - name: Install JRuby
      run: |
        source $HOME/.rvm/scripts/rvm
        rvm install ${JRUBY_VERSION}
        rvm --default use ${JRUBY_VERSION}
        gem install bundler
        bundle --version

    - name: Install Chrome
      run: |
        wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo dpkg -i google-chrome-stable_current_amd64.deb || apt-get -y -f install

    - name: bundle install
      run: |
        source $HOME/.rvm/scripts/rvm
        cd ${PANORAMA_DIR} && bundle install

    # create encypted wallet zip file to store in repository, add passphrase
    # gpg --symmetric --cipher-algo AES256 Wallet_PANORAMATEST.zip
    - name: Decrypt Wallet for database access
      env:
        GPG_KEY_FOR_DB_WALLET_ENCRYPTION: ${{ secrets.GPG_KEY_FOR_DB_WALLET_ENCRYPTION }}
      run: |
        cd ${PANORAMA_DIR}/.github && ./decrypt_DB_wallet.sh
        cd ${PANORAMA_DIR}/.github && unzip Wallet_PANORAMATEST.zip

    - name: run Test
      run: |
        source $HOME/.rvm/scripts/rvm
        cd ${PANORAMA_DIR} && rake test

