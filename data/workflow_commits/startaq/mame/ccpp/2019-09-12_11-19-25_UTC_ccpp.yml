name: CI

on:
  push:
    paths:
    - '*'
    - '!/hash/*'
  pull_request:
    paths:
    - '*'
    - '!/hash/*'

jobs:

#  build-linux-gcc:
#    runs-on: ubuntu-latest
#    steps:
#    - uses: actions/checkout@master
#    - name: Install dependencies
#      run: |
#        sudo apt-get update
#        sudo apt-get install -y gcc-9 g++-9 libsdl2-dev libsdl2-ttf-dev libasound2-dev libxinerama-dev libxi-dev qt5-default
#    - name: Build
#      env:
#        TOOLS: 1
#        OVERRIDE_CC: gcc-9
#        OVERRIDE_CXX: g++-9
#        ARCHOPTS: -U_FORTIFY_SOURCE
#      run: make -j2
#    - name: Validate
#      run: ./mame64 -validate
      
#  build-linux-clang:
#    runs-on: ubuntu-latest
#    steps:
#    - uses: actions/checkout@master
#    - name: Install dependencies
#      run: |
#        sudo apt-get update
#        sudo apt-get install -y clang libsdl2-dev libsdl2-ttf-dev libasound2-dev libxinerama-dev libxi-dev qt5-default
#    - name: Build
#      env:
#        TOOLS: 1
#        OVERRIDE_CXX: clang++
#        OVERRIDE_CC: clang
#      run: make -j2
#    - name: Validate
#      run: ./mame64 -validate

  build-windows-gcc:
    runs-on: windows-latest
    strategy:
      matrix:
        osd: [windows, sdl]
        include:
          - osd: sdl
            prefix: sdl
    steps:
    - uses: actions/checkout@master
    - name: Install build tools
      run: |
        curl -L https://github.com/mamedev/buildtools/releases/download/4.0/msys64-32-2019-03-25.exe -o msys64-32-2019-03-25.exe
        7z x -oC:\ msys64-32-2019-03-25.exe
        del msys64-32-2019-03-25.exe
    - name: Update build tools (core)
      run: |
        cd /D C:\msys64
        call win32\env.bat
        pacman -Syu --noconfirm
    - name: Update build tools (packages)
      run: |
        cd /D C:\msys64
        call win32\env.bat
        pacman -Syu --noconfirm
    - name: Build
      env:
        QT_DEBUG: 1
        TOOLS: 1
        OSD: ${{ matrix.osd }}
        SUBTARGET: tiny
      run: |
        cd /D C:\msys64
        call win32\env.bat
        cd /D %GITHUB_WORKSPACE%
        make -j2
    - name: Validate
      run: ${{ matrix.prefix }}mametiny64 -validate
    - name: Collect binaries (Windows)
      if: matrix.osd == 'windows'
      run: |
        mkdir bin
        copy sdlmame64.exe bin
    - name: Collect binaries (SDL)
      if: matrix.osd == 'sdl'
      run: |
        mkdir bin
        copy mame64.exe bin
    - uses: actions/upload-artifact@master
      with:
        name: win64-bin
        path: bin

#  build-macos-clang:
#    runs-on: macOS-latest
#    steps:
#    - uses: actions/checkout@master
#    - name: Install dependencies
#      run: |
#        curl -L http://www.libsdl.org/release/SDL2-2.0.10.dmg -o SDL2-2.0.10.dmg
#        hdiutil attach SDL2-2.0.10.dmg
#        cp -a /Volumes/SDL2/SDL2.framework ~/Library/Frameworks/
#    - name: Build
#      env:
#        SUBTARGET: tiny
#        VERBOSE: 1
#      run: |
#        make -j2
#    - name: Validate
#      run: ./mame64 -validate
