name: "Tests"

on:
    push:
        paths:
            - ".github/**/*"
            - "jumeaux/*"
            - "jumeaux/**/*"
            - "tests/*"
            - "tests/**/*"
            - "Pipfile.lock"
            - "test.bats"
            - "Makefile"
    schedule:
        - cron: "0 0 * * *"

jobs:
    test:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python: ["3.6", "3.7"]
        name: Python ${{ matrix.python }}

        steps:
            - name: Checkout a repository
              uses: actions/checkout@v1

            - name: Set up Python
              uses: actions/setup-python@v1
              with:
                  python-version: ${{ matrix.python }}
            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip pipenv
                  sed -ri 's/python_version = ".+"/python_version = "${{ matrix.python }}"/g' Pipfile
                  pipenv install --dev --skip-lock

            - name: Unit test
              id: unittest
              run: make test
            - name: Test report
              if: matrix.python == 3.7 && success()
              env:
                  CC_TEST_REPORTER_ID: 1561686e6399317b53a92aaad0550f8b91fe5af312e1f2852ab803ff6fcb6fa9
              run: |
                  curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
                  chmod +x ./cc-test-reporter
                  ./cc-test-reporter after-build

            - name: Install bats
              run: sudo npm install -g bats
            - name: CLI e2e test
              run: make test-cli

            - name: Slack notification
              uses: homoluctus/slatify@master
              if: always()
              with:
                  type: ${{ job.status }}
                  job_name: ":jumeaux: :python:*${{ matrix.python }}* Tests"
                  icon_emoji: "tio2"
                  url: ${{ secrets.SLACK_WEBHOOK }}
